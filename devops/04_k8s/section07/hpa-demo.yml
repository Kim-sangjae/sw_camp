# hpa-demo.yml

# 1) Deployment: 테스트 애플리케이션 배포
apiVersion: apps/v1
kind: Deployment
metadata:
  name: hpa-demo
spec:
  replicas: 1
  selector:
    matchLabels:
      app: hpa-demo
  template:
    metadata:
      labels:
        app: hpa-demo
    spec:
      containers:
        - name: web
          image: registry.k8s.io/hpa-example:latest
          # 요청이 들어오면 CPU 부하를 의도적으로 크게 올리는 이미지
          ports:
            - containerPort: 80
          resources:
            # Requests: Pod가 스케줄링될 최소 CPU (200m = 0.2 core)
            requests:
              cpu: "200m"
            # Limits: 최대 CPU 사용량 (500m = 0.5 core)
            limits:
              cpu: "500m"

---

# 2) Service: ClusterIP 형태의 내부 서비스
apiVersion: v1
kind: Service
metadata:
  name: hpa-demo-svc
spec:
  selector:
    app: hpa-demo
  ports:
    - port: 80       # 서비스가 노출하는 포트
      targetPort: 80 # Pod 안의 컨테이너 포트

---

# 3) HPA: CPU 기반 자동 스케일링 정책
apiVersion: autoscaling/v2
kind: HorizontalPodAutoscaler
metadata:
  name: hpa-demo-hpa
spec:
  scaleTargetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: hpa-demo
  minReplicas: 1   # 최소 Pod 개수
  maxReplicas: 5   # 최대 Pod 개수
  metrics:
    - type: Resource
      resource:
        name: cpu
        target:
          type: Utilization
          averageUtilization: 50  # 평균 CPU 사용량을 50%로 유지
